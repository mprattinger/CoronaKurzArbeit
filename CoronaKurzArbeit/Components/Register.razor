@using Models
@using Data
@using Extensions;
@using Services;

<button @onclick="RegisterTime" class="@Classes">Zeit buchen</button>

@code {

    [Inject]
    public IModalService Modal { get; set; } = default!;

    [Inject]
    public IAppState AppState { get; set; } = default!;

    [Inject]
    public ApplicationDbContext Context { get; set; } = default!;

    [Parameter]
    public DateTime AtDate { get; set; } = DateTime.MinValue;

    [CascadingParameter]
    public DateTime TheDate { get; set; } = DateTime.MinValue;

    [Parameter]
    public string Class { get; set; } = "";


    private string fixedClass = "btn btn-primary btn-block";
    private string Classes
    {
        get
        {
            return $"{fixedClass} {Class}";
        }
    }

    async Task RegisterTime()
    {
        var baseDate = AtDate == DateTime.MinValue ? TheDate : AtDate;
        var param = new ModalParameters();
        var tb = new TimeBooking();
        tb.BookingTime = baseDate.Date.AddHours(DateTime.Now.Hour).AddMinutes(DateTime.Now.Minute);
        param.Add(nameof(BookTime.Booking2Change), tb);
        var ret = Modal.Show<BookTime>("Zeit buchen", param);
        var result = await ret.Result;
        if (!result.Cancelled)
        {
            var changed = (TimeBooking)result.Data;
            Context.TimeBookings?.Add(changed);
            await Context.SaveChangesAsync();
            await AppState.RegisteredAsync(changed);
            StateHasChanged();
        }
    }
}
